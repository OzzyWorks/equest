<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ENGLISH QUEST - STABLE</title>
  <style>
    /* ÂÖ®‰Ωì„É¨„Ç§„Ç¢„Ç¶„Éà */
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    body { display: flex; flex-direction: column; box-sizing: border-box; padding: 10px; }
    
    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ */
    #loading-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 100;
    }
    .spinner { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ÁîªÈù¢Êè∫„Çå */
    @keyframes shake {
      0%, 100% { transform: translate(0,0); }
      25% { transform: translate(-8px, 0); }
      75% { transform: translate(8px, 0); }
    }
    .shake { animation: shake 0.2s ease-in-out 2; }

    /* „Ç≤„Éº„É†ÁîªÈù¢ÊßãÊàê */
    #game-container { display: none; flex: 1; flex-direction: column; }
    #game-screen {
      flex: 1; display: flex; flex-direction: column;
      background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 40%, #228b22 40%, #006400 100%);
      border: 4px solid #fff; border-radius: 8px; position: relative; overflow: hidden;
    }
    #mountain {
      position: absolute; top: 30%; left: 0; width: 100%; height: 15%;
      background: #004d00; clip-path: polygon(0% 100%, 15% 20%, 30% 70%, 50% 10%, 70% 60%, 85% 30%, 100% 100%);
    }

    #monster-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2; }
    #monster-image { font-size: 10vh; filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.5)); transition: transform 0.2s; }
    #monster-name-box { background: rgba(0,0,0,0.8); padding: 2px 12px; border: 2px solid #fff; border-radius: 4px; margin-bottom: 5px; font-weight: bold; }
    
    #boss-timer {
      display: none; position: absolute; top: 10px; right: 10px;
      background: #000; color: #ff4757; border: 2px solid #ff4757;
      padding: 5px; font-family: monospace; text-align: center; width: 70px; z-index: 10;
    }
    #timer-fill { height: 4px; background: #ff4757; width: 100%; margin-top: 2px; }

    /* Êìç‰Ωú„Ç®„É™„Ç¢ */
    #ui-area { flex: 1.5; display: flex; flex-direction: column; background: #000; border: 4px solid #fff; border-radius: 8px; margin-top: 8px; padding: 10px; z-index: 5; }
    #status { display: flex; justify-content: space-around; font-size: 0.8rem; border-bottom: 2px solid #fff; padding-bottom: 8px; margin-bottom: 5px; }
    
    .hp-danger { color: #ff4757; font-weight: bold; animation: blink 0.5s infinite alternate; }
    @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

    #question { font-size: 0.95rem; text-align: center; min-height: 3em; display: flex; align-items: center; justify-content: center; padding: 0 5px; }
    #choices { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    #choices button { padding: 15px 5px; font-size: 0.8rem; background: #000; color: #fff; border: 2px solid #fff; border-radius: 4px; cursor: pointer; }
    
    #heal-btn { 
      display: none; width: 100%; margin-bottom: 10px; padding: 12px; 
      background: #2ed573; color: #fff; border: none; border-radius: 4px; font-weight: bold; font-size: 1rem;
    }

    #log { font-size: 0.85rem; color: #ffff00; text-align: center; margin: 8px 0; height: 1.2em; font-weight: bold; }
    #next { width: 100%; padding: 15px; background: #fff; color: #000; font-weight: bold; border: none; display: none; font-size: 1.1rem; border-radius: 4px; cursor: pointer; }
    
    .correct { background: #2ecc71 !important; }
    .wrong { background: #e74c3c !important; }
  </style>
</head>
<body id="main-body">

  <div id="loading-screen">
    <div class="spinner"></div>
    <p style="margin-top: 20px; font-weight: bold; letter-spacing: 2px;">NOW LOADING...</p>
  </div>

  <div id="game-container">
    <div id="game-screen">
      <div id="mountain"></div>
      <div id="boss-timer">TIME:<span id="time-num">10</span><div id="timer-fill"></div></div>
      
      <div id="monster-area">
        <div id="monster-name-box"><span id="monster-name">...</span></div>
        <div id="monster-image">üêæ</div>
        <div style="width:60%; height:10px; background:#444; border:1px solid #fff; margin-top:8px;">
          <div id="monster-hp" style="height:100%; background:#f00; width:100%; transition:width 0.2s;"></div>
        </div>
      </div>
    </div>

    <div id="ui-area">
      <div id="status">
        <div>LV: <span id="level">1</span></div>
        <div id="hp-box">HP: <span id="hp">100</span></div>
        <div>Â±ûÊÄß: <span id="p-element">üî•</span></div>
      </div>
      
      <div id="question"></div>
      <button id="heal-btn">üåø Ëñ¨Ëçâ„Çí‰Ωø„ÅÜ (HPÂÖ®ÂõûÂæ©)</button>
      <div id="choices"></div>
      
      <div id="log"></div>
      <button id="next"></button>
    </div>
  </div>

  <script>
    const masterQuestions = [
      { q: "I (  ) to the park yesterday.", choices: ["went", "go", "gone", "going"], a: "went" },
      { q: "This is the car (  ) he bought.", choices: ["which", "who", "whom", "whose"], a: "which" },
      { q: "He is (  ) than I am.", choices: ["taller", "tall", "tallest", "more tall"], a: "taller" },
      { q: "If I (  ) a bird, I would fly.", choices: ["were", "am", "was", "is"], a: "were" },
      { q: "I have (  ) to Kyoto twice.", choices: ["been", "gone", "be", "go"], a: "been" },
      { q: "She (  ) lunch now.", choices: ["is eating", "eats", "ate", "eaten"], a: "is eating" },
      { q: "It is easy (  ) me to swim.", choices: ["for", "of", "to", "at"], a: "for" },
      { q: "„Äåenvironment„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", choices: ["Áí∞Â¢É", "ÊîøÂ∫ú", "ÁøíÊÖ£", "ÊúüÂæÖ"], a: "Áí∞Â¢É" },
      { q: "„Äåopportunity„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", choices: ["Ê©ü‰ºö", "Â†¥ÊâÄ", "ÊôÇÈñì", "ÊàêÂäü"], a: "Ê©ü‰ºö" },
      { q: "„Äåtake care (  )„Äç„Åß„Äå‰∏ñË©±„Çí„Åô„Çã„Äç", choices: ["of", "for", "to", "at"], a: "of" },
      { q: "„Äålook forward (  )„Äç„Åß„ÄåÊ•Ω„Åó„Åø„Å´„Åô„Çã„Äç", choices: ["to", "at", "for", "on"], a: "to" }
    ];

    let player = { level: 1, exp: 0, hp: 100, element: "üî•", winCount: 0 };
    const elements = { "üî•": "üíß", "üíß": "üåø", "üåø": "üî•" };
    let pool = [];
    let usedPool = [];
    let currentMonster = {};
    let timerInt;
    let timeLeft = 10;
    let isBoss = false;

    // ÂàùÊúüÂåñ„Å®„É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§
    function init() {
      setTimeout(() => {
        pool = [...masterQuestions].sort(() => Math.random() - 0.5);
        document.getElementById("loading-screen").style.display = "none";
        document.getElementById("game-container").style.display = "flex";
        nextBattle();
      }, 800); // ÊºîÂá∫„Å®„Åó„Å¶Â∞ë„Åó„Å†„ÅëÂæÖÊ©ü
    }

    function nextBattle() {
      player.winCount++;
      isBoss = player.winCount % 5 === 0;
      
      const monsters = [{n:"„Çπ„É©„Ç§„É†",i:"üíß",t:"üíß"},{n:"„Éâ„É©„Ç≠„Éº",i:"ü¶á",t:"üåø"},{n:"„Ç¥„Éº„Çπ„Éà",i:"üëª",t:"üî•"}];
      const bosses = [{n:"„Çä„ÇÖ„ÅÜ„Åä„ÅÜ",i:"üê≤",t:"üî•"},{n:"„Éù„Çª„Ç§„Éâ„É≥",i:"üî±",t:"üíß"},{n:"Â§ßÈï∑ËÄÅ",i:"üå≥",t:"üåø"}];
      
      let m = isBoss ? bosses[Math.floor(Math.random()*bosses.length)] : monsters[Math.floor(Math.random()*monsters.length)];
      currentMonster = { ...m, maxHp: isBoss ? 200 : 50, hp: isBoss ? 200 : 50 };

      document.getElementById("monster-name").textContent = (isBoss ? "BOSS: " : "") + currentMonster.n;
      document.getElementById("monster-image").textContent = currentMonster.i;
      document.getElementById("boss-timer").style.display = isBoss ? "block" : "none";
      document.getElementById("next").style.display = "none";
      document.getElementById("log").textContent = isBoss ? "Âº∑Â§ß„Å™„Éú„Çπ„ÅåÁèæ„Çå„ÅüÔºÅ" : "„É¢„É≥„Çπ„Çø„Éº„ÅåÁèæ„Çå„ÅüÔºÅ";
      
      loadQuestion();
      updateDisplay();
    }

    function loadQuestion() {
      clearInterval(timerInt);
      if (pool.length === 0) {
        pool = [...usedPool].sort(() => Math.random() - 0.5);
        usedPool = [];
      }
      const qData = pool.pop();
      usedPool.push(qData);

      document.getElementById("question").textContent = qData.q;
      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";

      [...qData.choices].sort(()=>Math.random()-0.5).forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => checkAnswer(c, qData.a, btn);
        choicesEl.appendChild(btn);
      });

      if (isBoss) startBossTimer();
    }

    function startBossTimer() {
      timeLeft = 10;
      updateTimerUI();
      timerInt = setInterval(() => {
        timeLeft -= 0.1;
        updateTimerUI();
        if (timeLeft <= 0) {
          clearInterval(timerInt);
          handleDamage(10, "ÊôÇÈñìÂàá„ÇåÔºÅ10„ÉÄ„É°„Éº„Ç∏ÔºÅ");
          setTimeout(loadQuestion, 800);
        }
      }, 100);
    }

    function updateTimerUI() {
      document.getElementById("time-num").textContent = Math.ceil(timeLeft);
      document.getElementById("timer-fill").style.width = (timeLeft * 10) + "%";
    }

    function checkAnswer(choice, answer, btn) {
      clearInterval(timerInt);
      const buttons = document.querySelectorAll("#choices button");
      buttons.forEach(b => { b.disabled = true; });

      if (choice === answer) {
        btn.classList.add("correct");
        let damage = (elements[player.element] === currentMonster.t) ? 60 : 25;
        currentMonster.hp -= damage;
        document.getElementById("log").textContent = "Ê≠£Ëß£ÔºÅ ÊîªÊíÉ„Åó„ÅüÔºÅ";
        document.getElementById("monster-image").style.transform = "scale(1.4)";
        setTimeout(()=>document.getElementById("monster-image").style.transform="scale(1)", 150);
      } else {
        btn.classList.add("wrong");
        buttons.forEach(b => { if(b.textContent === answer) b.classList.add("correct"); });
        handleDamage(10, "‰∏çÊ≠£Ëß£ÔºÅ10„ÉÄ„É°„Éº„Ç∏ÔºÅ");
      }

      setTimeout(() => {
        if (currentMonster.hp <= 0) {
          document.getElementById("log").textContent = "ÂãùÂà©„Åó„ÅüÔºÅ";
          player.exp += isBoss ? 100 : 30;
          const nextBtn = document.getElementById("next");
          nextBtn.textContent = "‚ñ∂ Ê¨°„ÅÆ„Éê„Éà„É´„Å∏"; // Ê≠£„Åó„ÅèË®≠ÂÆö
          nextBtn.style.display = "block";
          levelUpCheck();
        } else if (player.hp <= 0) {
          document.getElementById("log").textContent = "ÂÖ®ÊªÖ„Åó„Å¶„Åó„Åæ„Å£„Åü...";
          player.hp = 100; player.winCount = 0;
          const nextBtn = document.getElementById("next");
          nextBtn.textContent = "‚ñ∂ Âæ©Ê¥ª„Åô„Çã"; // ÊïóÂåóÊôÇ„ÅØ„Åì„Å°„Çâ
          nextBtn.style.display = "block";
        } else {
          loadQuestion();
        }
        updateDisplay();
      }, 1000);
    }

    function handleDamage(dmg, msg) {
      player.hp -= dmg;
      if (player.hp < 0) player.hp = 0;
      document.getElementById("log").textContent = msg;
      document.getElementById("main-body").classList.add("shake");
      setTimeout(() => document.getElementById("main-body").classList.remove("shake"), 300);
      updateDisplay();
    }

    function updateDisplay() {
      const hpEl = document.getElementById("hp");
      hpEl.textContent = player.hp;
      if (player.hp <= 30) hpEl.classList.add("hp-danger");
      else hpEl.classList.remove("hp-danger");
      document.getElementById("heal-btn").style.display = (player.hp <= 20 && player.hp > 0) ? "block" : "none";
      document.getElementById("monster-hp").style.width = (currentMonster.hp / currentMonster.maxHp * 100) + "%";
      document.getElementById("level").textContent = player.level;
      document.getElementById("p-element").textContent = player.element;
    }

    document.getElementById("heal-btn").onclick = () => {
      player.hp = 100;
      document.getElementById("log").textContent = "Ëñ¨Ëçâ„ÅßHP„ÅåÂÖ®Âø´„Åó„ÅüÔºÅ";
      updateDisplay();
    };

    function levelUpCheck() {
      if (player.exp >= 100) {
        player.level++; player.exp = 0;
        player.element = ["üî•", "üíß", "üåø"][player.level % 3];
      }
    }

    document.getElementById("next").onclick = () => {
      nextBattle();
    };

    window.onload = init;
  </script>
</body>
</html>
