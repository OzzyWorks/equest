<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ENGLISH QUEST - ULTIMATE PLUS</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    body { display: flex; flex-direction: column; box-sizing: border-box; padding: 10px; }
    #game-screen { flex: 1; display: flex; flex-direction: column; background: linear-gradient(to bottom, #1e3c72, #2a5298); border: 4px solid #fff; border-radius: 8px; position: relative; overflow: hidden; }
    #monster-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    /* „É¢„É≥„Çπ„Çø„Éº„Éª„Éú„Éº„Éä„ÇπË°®Á§∫„Ç®„É™„Ç¢ */
    #monster-image-box { width: 180px; height: 180px; background: #fff; border: 4px solid #ffd700; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    #monster-emoji { font-size: 80px; }
    
    /* „Éú„Éº„Éä„ÇπÁîªÂÉèË°®Á§∫Áî®„ÅÆ„É¨„Ç§„É§„Éº (3x3ÂàÜÂâ≤Ë°®Á§∫Áî®) */
    #bonus-image-view { 
      display: none; width: 100%; height: 100%; 
      background-image: url('1000046944.jpg'); 
      background-size: 300% 300%; /* 3x3ÂàÜÂâ≤„ÅÆ„Åü„ÇÅ300% */
      background-repeat: no-repeat;
    }
    /* ÂãùÂà©ÊôÇÁîªÂÉèÁî®„ÅÆ„É¨„Ç§„É§„Éº */
    #victory-image-view { display: none; width: 100%; height: 100%; object-fit: contain; }

    #boss-timer { display: none; position: absolute; top: 10px; right: 10px; background: #000; color: #ff4757; border: 2px solid #ff4757; padding: 5px; font-family: monospace; width: 70px; text-align: center; z-index: 10; }
    #timer-fill { height: 4px; background: #ff4757; width: 100%; margin-top: 2px; }
    #ui-area { flex: 1.5; display: flex; flex-direction: column; background: #000; border: 4px solid #fff; border-radius: 8px; margin-top: 8px; padding: 10px; position: relative; }
    #status { display: flex; justify-content: space-around; font-size: 0.85rem; border-bottom: 2px solid #fff; padding-bottom: 5px; }
    #question { font-size: 0.95rem; text-align: center; min-height: 4.5em; display: flex; align-items: center; justify-content: center; padding: 5px; }
    #choices { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    #choices button { padding: 15px 5px; font-size: 0.85rem; background: #000; color: #fff; border: 2px solid #fff; border-radius: 5px; cursor: pointer; }
    #log { font-size: 0.9rem; color: #ffff00; text-align: center; margin: 5px 0; font-weight: bold; min-height: 1.2em; }
    #next-area { display: none; text-align: center; }
    #next, #btn-review-open { padding: 12px; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 5px; }
    #next { background: #fff; color: #000; width: 60%; }
    #btn-review-open { background: #555; color: #fff; border: 1px solid #fff; }
    #bonus-banner { display: none; position: absolute; top: 15%; left: 50%; transform: translateX(-50%); color: gold; font-size: 1.8rem; font-weight: bold; text-shadow: 2px 2px #000; z-index: 5; animation: flash 0.5s infinite alternate; }
    #review-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; border: 3px solid gold; }
    @keyframes flash { from { opacity: 1; } to { opacity: 0.3; } }
    .shake { animation: shake 0.2s ease-in-out 2; }
    @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-8px,0); } 75% { transform: translate(8px,0); } }
  </style>
</head>
<body>

  <div id="game-screen">
    <div id="bonus-banner">BONUS STAGE</div>
    <div id="boss-timer">TIME:<span id="time-num">10</span><div id="timer-fill"></div></div>
    <div id="monster-area">
      <div id="monster-image-box">
        <span id="monster-emoji">üëæ</span>
        <div id="bonus-image-view"></div>
        <img id="victory-image-view" src="" alt="">
      </div>
      <div style="width:140px; height:12px; background:#333; border:2px solid #fff; margin-top:10px;">
        <div id="monster-hp-bar" style="height:100%; background:#f00; width:100%; transition: width 0.3s;"></div>
      </div>
    </div>
  </div>

  <div id="ui-area">
    <div id="status">
      <div id="hp-display">HP: <span id="hp">100</span></div>
      <div>WIN: <span id="wins">0</span></div>
      <div>LV: <span id="level">1</span></div>
    </div>
    <div id="question"></div>
    <div id="choices"></div>
    <div id="log"></div>
    
    <div id="next-area">
      <button id="next">‚ñ∂ NEXT BATTLE</button>
      <button id="btn-review-open" onclick="showReview()">MISS LIST</button>
    </div>

    <div id="review-modal">
      <h3 style="color:gold; text-align:center;">MISS LIST (Âæ©Áøí)</h3>
      <div id="review-list" style="font-size:0.85rem; line-height:1.6;"></div>
      <button onclick="closeReview()" style="width:100%; padding:15px; margin-top:20px; background:gold; font-weight:bold;">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <script src="questions.js"></script>
  <script>
    let player = { hp: 100, wins: 0, maxHp: 100, canHeal: true };
    let monster = { hp: 70, maxHp: 70 };
    let pool = [], usedPool = [], missList = [];
    let isBoss = false, isBonus = false, bossMistakes = 0;
    let timerInt, timeLeft = 10, bonusImgInterval, currentQ = null;

    // 3x3ÂàÜÂâ≤„ÅÆÂ∫ßÊ®ôÂÆöÁæ© (0%, 50%, 100% „ÅÆÁµÑ„ÅøÂêà„Çè„Åõ)
    const positions = [
      "0% 0%", "50% 0%", "100% 0%",
      "0% 50%", "50% 50%", "100% 50%",
      "0% 100%", "50% 100%", "100% 100%"
    ];

    function speak(text) {
      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = "ja-JP"; uttr.pitch = 0.4; uttr.rate = 0.8;
      window.speechSynthesis.speak(uttr);
    }

    function init() {
      if (typeof masterQuestions === 'undefined') { alert("questions.js„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); return; }
      pool = [...masterQuestions].sort(() => Math.random() - 0.5);
      startBattle();
    }

    function startBattle() {
      clearInterval(bonusImgInterval); clearInterval(timerInt);
      isBonus = false; bossMistakes = 0; player.canHeal = true;
      isBoss = (player.wins > 0 && (player.wins + 1) % 5 === 0);
      monster.maxHp = isBoss ? 200 : 70; monster.hp = monster.maxHp;
      
      document.getElementById("monster-emoji").style.display = "block";
      document.getElementById("bonus-image-view").style.display = "none";
      document.getElementById("victory-image-view").style.display = "none";
      document.getElementById("boss-timer").style.display = isBoss ? "block" : "none";
      document.getElementById("bonus-banner").style.display = "none";
      document.getElementById("next-area").style.display = "none";
      document.getElementById("log").textContent = isBoss ? "„Éú„ÇπÊà¶ÔºÅ„Éé„Éº„Éü„Çπ„Åß„Éú„Éº„Éä„Çπ„Å∏" : "Êïµ„ÅåÁèæ„Çå„ÅüÔºÅ";
      
      updateUI(); loadQuestion();
    }

    function loadQuestion() {
      if (pool.length === 0) { pool = [...usedPool].sort(() => Math.random() - 0.5); usedPool = []; }
      if (player.hp <= 20 && player.canHeal) { showHealEvent(); return; }

      currentQ = pool.pop();
      document.getElementById("question").textContent = currentQ.q;
      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";
      [...currentQ.choices].sort(() => Math.random() - 0.5).forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => checkAnswer(c);
        choicesEl.appendChild(btn);
      });
      if (isBoss) startTimer();
    }

    function showHealEvent() {
      document.getElementById("question").innerHTML = "<span style='color:ff4757; font-weight:bold;'>„Éî„É≥„ÉÅ„Å†ÔºÅ‰ΩìÂà∂„ÇíÁ´ã„Å¶Áõ¥„Åó„Åæ„Åô„ÅãÔºü</span>";
      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";
      const healBtn = document.createElement("button");
      healBtn.textContent = "Á•à„ÇäÔºàHP50ÂõûÂæ©Ôºâ";
      healBtn.style.gridColumn = "1 / span 2"; healBtn.style.background = "#2ecc71";
      healBtn.onclick = () => {
        player.hp = Math.min(player.maxHp, player.hp + 50);
        player.canHeal = false;
        document.getElementById("log").textContent = "HP„ÅåÂõûÂæ©„Åó„ÅüÔºÅ";
        updateUI(); loadQuestion();
      };
      choicesEl.appendChild(healBtn);
    }

    function startTimer() {
      timeLeft = 10; clearInterval(timerInt);
      timerInt = setInterval(() => {
        timeLeft -= 0.1;
        document.getElementById("time-num").textContent = Math.ceil(timeLeft);
        document.getElementById("timer-fill").style.width = (timeLeft * 10) + "%";
        if (timeLeft <= 0) { 
          clearInterval(timerInt); bossMistakes++; damagePlayer(10); 
          highlightCorrect(); document.getElementById("log").textContent = "ÊôÇÈñìÂàá„ÇåÔºÅ"; 
          setTimeout(loadQuestion, 1200); 
        }
      }, 100);
    }

    function checkAnswer(choice) {
      clearInterval(timerInt);
      highlightCorrect();
      if (choice === currentQ.a) {
        monster.hp -= 50; document.getElementById("log").textContent = "Ê≠£Ëß£ÔºÅ";
        if (isBonus) speak("„ÇÑ„Çä„Åæ„Åô„Å≠„Åá");
        usedPool.push(currentQ);
      } else {
        if (isBoss) bossMistakes++;
        missList.push({q: currentQ.q, a: currentQ.a, user: choice});
        damagePlayer(15); document.getElementById("log").textContent = "‰∏çÊ≠£Ëß£ÔºÅ";
        pool.unshift(currentQ);
      }
      updateUI();
      setTimeout(() => {
        if (monster.hp <= 0) handleDefeat();
        else loadQuestion();
      }, 1200);
    }

    function highlightCorrect() {
      const btns = document.querySelectorAll("#choices button");
      btns.forEach(b => {
        b.disabled = true;
        if (b.textContent === currentQ.a) b.style.background = "#2ecc71";
        else b.style.opacity = "0.5";
      });
    }

    function handleDefeat() {
      if (isBoss && bossMistakes === 0) {
        startBonus();
      } else {
        if (isBonus) { 
          clearInterval(bonusImgInterval);
          speak("„Åò„ÇÉ„Åë„Çì„ÄÅÂ§úË°å„Åç„Åæ„Åó„Çá„ÅÜ„Å≠"); 
          document.getElementById("bonus-image-view").style.display = "none";
          const vic = document.getElementById("victory-image-view");
          vic.style.display = "block"; vic.src = "1000046945.png";
        }
        player.wins++;
        document.getElementById("log").textContent = "VICTORY!";
        document.getElementById("next-area").style.display = "block";
        document.getElementById("choices").innerHTML = "";
      }
    }

    function startBonus() {
      isBonus = true; isBoss = false; monster.maxHp = 150; monster.hp = 150;
      document.getElementById("bonus-banner").style.display = "block";
      document.getElementById("monster-emoji").style.display = "none";
      
      const bView = document.getElementById("bonus-image-view");
      bView.style.display = "block";
      
      // 2Áßí„Åî„Å®„Å´„É©„É≥„ÉÄ„É†„Å™3x3„ÅÆÈÉ®‰Ωç„ÇíË°®Á§∫
      bonusImgInterval = setInterval(() => {
        const rndPos = positions[Math.floor(Math.random() * positions.length)];
        bView.style.backgroundPosition = rndPos;
        bView.style.filter = `hue-rotate(${Math.random()*360}deg)`;
      }, 2000);

      updateUI(); loadQuestion();
    }

    function damagePlayer(dmg) {
      player.hp -= dmg;
      document.body.classList.add("shake");
      setTimeout(() => document.body.classList.remove("shake"), 200);
      if (player.hp <= 0) { player.hp = 0; updateUI(); showReview(); }
    }

    function updateUI() {
      document.getElementById("hp").textContent = player.hp;
      document.getElementById("hp-display").style.color = player.hp <= 20 ? "#ff4757" : "#fff";
      document.getElementById("wins").textContent = player.wins;
      document.getElementById("level").textContent = Math.floor(player.wins / 3) + 1;
      const pct = Math.max(0, (monster.hp / monster.maxHp) * 100);
      document.getElementById("monster-hp-bar").style.width = pct + "%";
    }

    function showReview() {
      const modal = document.getElementById("review-modal");
      const list = document.getElementById("review-list");
      list.innerHTML = missList.length === 0 ? "„Éü„Çπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ" : "";
      missList.forEach((m, i) => {
        list.innerHTML += `<div style="margin-bottom:10px;">${i+1}. ${m.q}<br><span style="color:#ff4757;">√ó ${m.user}</span> ‚Üí <span style="color:#2ecc71;">‚óã ${m.a}</span></div><hr style="border:0.5px solid #444;">`;
      });
      modal.style.display = "block";
    }

    function closeReview() {
      if (player.hp <= 0) location.reload();
      else document.getElementById("review-modal").style.display = "none";
    }

    document.getElementById("next").onclick = startBattle;
    window.onload = init;
  </script>
</body>
</html>
