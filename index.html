<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ENGLISH QUEST - DQ EDITION</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; font-family: 'Courier New', Consolas, monospace; }
    body { display: flex; flex-direction: column; box-sizing: border-box; padding: 10px; position: relative; }

    #version-tag { 
      position: absolute; top: 5px; right: 10px; font-size: 0.8rem; color: #fff; 
      text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
      z-index: 2000; pointer-events: none; font-weight: bold;
    }

    #game-screen { 
      flex: 1; display: flex; flex-direction: column; 
      background: linear-gradient(to bottom, #000080 0%, #0000ff 50%, #40a0ff 100%); 
      border: 4px solid #fff; border-radius: 8px; position: relative; overflow: hidden; 
    }
    
    #monster-area { 
      flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; 
      background: radial-gradient(ellipse at bottom, #228b22 0%, rgba(0,0,0,0) 70%);
      position: relative;
    }
    
    #monster-image-box { width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    #monster-emoji { font-size: 100px; filter: drop-shadow(0 0 10px #000); }
    #monster-name { background: rgba(0,0,0,0.7); padding: 2px 10px; border: 1px solid #fff; font-size: 0.9rem; margin-bottom: 5px; color: #fff; }

    /* ÁóõÊÅ®„ÅÆÁ®≤Â¶ª */
    .thunder {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 0, 0, 0.3); z-index: 500; pointer-events: none;
      animation: thunder-flash 0.1s steps(2) infinite;
    }
    .thunder::before {
      content: "‚ö°"; position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(20); color: #ff4757;
      text-shadow: 0 0 20px #fff; opacity: 0.8;
    }
    @keyframes thunder-flash {
      0% { opacity: 0; }
      50% { opacity: 1; background: rgba(255, 0, 0, 0.5); }
      100% { opacity: 0; }
    }

    /* „ÇØ„É™„ÉÜ„Ç£„Ç´„É´ÊºîÂá∫ */
    .slash {
      position: absolute; width: 5px; height: 250px; background: yellow;
      top: 50%; left: 50%; z-index: 150;
      transform: translate(-50%, -50%) rotate(45deg) scaleY(0);
      box-shadow: 0 0 15px yellow;
      animation: slash-ani 0.3s ease-out forwards;
    }
    @keyframes slash-ani {
      0% { transform: translate(-50%, -50%) rotate(45deg) scaleY(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(45deg) scaleY(1.5); opacity: 0; }
    }
    .critical-text {
      position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
      color: yellow; font-size: 1.8rem; font-weight: bold; font-style: italic;
      text-shadow: 3px 3px 0 #000; z-index: 160;
      white-space: nowrap; animation: crit-text-ani 0.5s ease-out forwards;
      pointer-events: none;
    }
    @keyframes crit-text-ani {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -60%) scale(1); opacity: 0; }
    }

    .flash-blue { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 100, 255, 0.4); pointer-events: none; z-index: 100; animation: fade-out 0.5s forwards; }
    @keyframes fade-out { from { opacity: 1; } to { opacity: 0; } }
    .critical-shake { animation: c-shake 0.1s ease-in-out infinite; }
    @keyframes c-shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-10px, 10px); } 75% { transform: translate(10px, -10px); } }

    #ui-area { flex: 1.5; display: flex; flex-direction: column; background: #000; border: 4px solid #fff; border-radius: 8px; margin-top: 8px; padding: 12px; position: relative; }
    #status { display: flex; justify-content: space-around; align-items: center; font-size: 0.85rem; border-bottom: 2px solid #fff; padding-bottom: 8px; margin-bottom: 8px; }
    #btn-anytime-review { padding: 4px 8px; background: #444; color: #fff; border: 1px solid #fff; font-size: 0.7rem; cursor: pointer; }
    #question { font-size: 1rem; text-align: center; min-height: 4.5em; display: flex; align-items: center; justify-content: center; padding: 5px; line-height: 1.4; }
    #choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    #choices button { padding: 15px 5px; font-size: 0.9rem; background: #000; color: #fff; border: 2px solid #fff; border-radius: 0; cursor: pointer; }
    #log { font-size: 0.8rem; color: #ffff00; text-align: center; margin: 8px 0; font-weight: bold; min-height: 2.4em; }
    #next-area { display: none; text-align: center; }
    .action-btn { padding: 12px; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 5px; border: 2px solid #fff; background: #fff; color: #000; width: 80%; }
    .menu-btn { background: #444 !important; color: #fff !important; }

    #difficulty-modal, #review-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; padding: 20px; box-sizing: border-box; border: 4px solid gold; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .diff-btn { width: 80%; padding: 20px; margin: 10px; font-size: 1.2rem; font-weight: bold; border: 3px solid #fff; background: #000; color: #fff; cursor: pointer; }
    .review-item { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; text-align: left; width: 100%; }
    .btn-focus { padding: 5px 10px; background: #e74c3c; color: #fff; border: none; font-size: 0.7rem; cursor: pointer; margin-top: 5px; font-weight: bold; }

    #bonus-image-view { display: none; width: 100%; height: 100%; background-image: url('1000046944.jpg'); background-size: 300% 300%; background-repeat: no-repeat; border: 4px solid #ffd700; border-radius: 12px; }
    #victory-image-view { display: none; width: 100%; height: 100%; object-fit: contain; background: #fff; border-radius: 12px; }
    #boss-timer { display: none; position: absolute; top: 10px; right: 10px; background: #000; color: #ff4757; border: 2px solid #fff; padding: 5px; width: 80px; text-align: center; z-index: 10; }
    #timer-fill { height: 4px; background: #ff4757; width: 100%; margin-top: 2px; }

    @keyframes flash { from { opacity: 1; } to { opacity: 0.3; } }
    .shake { animation: shake 0.2s ease-in-out 2; }
    @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-8px,0); } 75% { transform: translate(8px,0); } }
  </style>
</head>
<body>

  <div id="version-tag">v.1.07</div>

  <div id="difficulty-modal" style="display: flex;">
    <div id="diff-content">
      <h2 id="diff-title" style="color:gold; margin-bottom: 30px;">ÈáéÁç£ÂÖàËº©„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏</h2>
      <p style="color:#fff; margin-bottom:20px;">„Å©„ÅÆ „Åº„ÅÜ„Åë„Çì„Å´ „Åß„Åã„Åë„Çã„Çì„Å†„ÅÑÔºü</p>
      <div id="diff-buttons">
        <button class="diff-btn" onclick="selectDifficulty('questions.js')">ÊôÆÈÄöÁ∑®</button>
        <button class="diff-btn" onclick="selectDifficulty('questions2.js')" style="border-color: #e74c3c; color: #e74c3c;">ÂøúÁî®Á∑®</button>
      </div>
      <div id="loading-msg" style="display: none;">
        <p style="color: #fff; font-size: 1.2rem; animation: flash 0.5s infinite alternate;">„Éá„Éº„Çø„Çí „Çà„Åø„Åì„Çì„Åß„ÅÑ„Åæ„Åô...</p>
      </div>
    </div>
  </div>

  <div id="game-screen">
    <div id="bonus-banner" style="display:none; position:absolute; top:15%; left:50%; transform:translateX(-50%); color:gold; font-size:2rem; font-weight:bold; text-shadow:3px 3px #000; z-index:5; animation:flash 0.5s infinite alternate;">BONUS STAGE</div>
    <div id="boss-timer">TIME:<span id="time-num">10</span><div id="timer-fill"></div></div>
    <div id="monster-area">
      <div id="monster-name"></div>
      <div id="monster-image-box">
        <span id="monster-emoji">üëæ</span>
        <div id="bonus-image-view"></div>
        <img id="victory-image-view" src="" alt="">
      </div>
      <div style="width:140px; height:12px; background:#333; border:2px solid #fff; margin-top:20px;">
        <div id="monster-hp-bar" style="height:100%; background:#f00; width:100%; transition: width 0.3s;"></div>
      </div>
      <div id="monster-effects" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>
    </div>
    <div id="effect-layer"></div>
  </div>

  <div id="ui-area">
    <div id="status">
      <div id="hp-display">HP:<span id="hp">100</span></div>
      <div>WIN:<span id="wins">0</span></div>
      <div>LV:<span id="level">1</span></div>
      <button id="btn-anytime-review" onclick="openReviewAnytime()">„Éü„Çπ„Çí„Åø„Çã</button>
    </div>
    <div id="question"></div>
    <div id="choices"></div>
    <div id="log"></div>
    <div id="next-area">
      <button id="next" class="action-btn" onclick="startBattle()">‚ñ∂ „Å§„Åé„ÅÆ „Åü„Åü„Åã„ÅÑ„Å∏</button>
      <button id="btn-menu" class="action-btn menu-btn" style="display:none;" onclick="returnToMenu()">‚ñ∂ „Éà„ÉÉ„Éó„É°„Éã„É•„Éº„Å∏„ÇÇ„Å©„Çã</button>
    </div>

    <div id="review-modal">
      <h3 style="color:gold; text-align:center;">MISS LIST (Âæ©Áøí)</h3>
      <div id="review-list" style="font-size:0.85rem; line-height:1.6; max-height: 60vh; overflow-y: auto; width: 100%;"></div>
      <button onclick="closeReview()" style="width:100%; padding:15px; margin-top:20px; background:gold; font-weight:bold; color:#000; border:none;">„Å®„Åò„Çã</button>
    </div>
  </div>

  <script>
    let player = { hp: 100, wins: 0, maxHp: 100, canHeal: true };
    let monster = { hp: 70, maxHp: 70 };
    let pool = [], usedPool = [], missList = [];
    let isBoss = false, isBonus = false, bossMistakes = 0;
    let timerInt, timeLeft = 10, bonusImgInterval, currentQ = null;

    const monsterData = [{emoji:"üëª",name:"„Ç¥„Éº„Çπ„Éà"},{emoji:"ü¶á",name:"„Éâ„É©„Ç≠„Éº"},{emoji:"üê∫",name:"„É™„Ç´„É≥„Éà"},{emoji:"üêç",name:"„Åä„Åä„Åï„Åù„Çä"},{emoji:"üï∑Ô∏è",name:"Â§ß„Ç∞„É¢"},{emoji:"üíÄ",name:"„Åå„ÅÑ„Åì„Å§ÂÖµ"}];
    const bonusBgm = new Audio('sentou-two.mp3');
    bonusBgm.loop = true;
    bonusBgm.volume = 0.3;

    function speakEnglish(text) {
      const uttr = new SpeechSynthesisUtterance();
      let engPart = text.match(/„Äå(.+?)„Äç/) ? text.match(/„Äå(.+?)„Äç/)[1] : text.replace(/\(.+?\)/, "blank");
      uttr.text = engPart; uttr.lang = "en-US";
      const voices = window.speechSynthesis.getVoices();
      const femaleVoice = voices.find(v => v.lang.startsWith('en') && (v.name.includes('Female') || v.name.includes('Google US English') || v.name.includes('Samantha') || v.name.includes('Zira')));
      if (femaleVoice) uttr.voice = femaleVoice;
      uttr.rate = 0.9; uttr.pitch = 1.1;
      window.speechSynthesis.speak(uttr);
    }

    function speak(text) {
      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = "ja-JP";
      const voices = window.speechSynthesis.getVoices();
      const jaVoice = voices.find(v => v.lang === 'ja-JP');
      if (jaVoice) uttr.voice = jaVoice;
      uttr.pitch = 0.4; uttr.rate = 1.6;
      window.speechSynthesis.speak(uttr);
    }

    function checkAnswer(choice) {
      clearInterval(timerInt);
      if (!currentQ) return;
      highlightCorrect();

      let delay = 1200; // Ê¨°„ÅÆÂ±ïÈñã„Å∏„ÅÆÂæÖÊ©üÊôÇÈñì

      if (choice === currentQ.a) {
        let isCritical = Math.random() < 0.2;
        let dmg = isCritical ? 50 : 20;
        monster.hp -= dmg; 
        if (isCritical) triggerCriticalEffect();
        else document.getElementById("log").textContent = "20„ÅÆ„ÉÄ„É°„Éº„Ç∏„Çí„ÅÇ„Åü„Åà„ÅüÔºÅ";
        speak(isBonus ? "„ÇÑ„Çä„Åæ„Åô„Å≠„Åá„Åá" : "„Åä„Å£„ÄÅ„Åù„ÅÜ„Å†„Å™"); 
        usedPool.push(currentQ);
      } else {
        if (isBoss) bossMistakes++;
        if (!missList.find(m => m.q === currentQ.q)) missList.push({q:currentQ.q, a:currentQ.a, choices:currentQ.choices});
        
        let isGraveError = Math.random() < 0.2; 
        let playerDmg = 10; 

        if (isGraveError) {
          triggerThunderEffect();
          document.getElementById("log").innerHTML = "<span style='color:red; font-size:1.1rem;'>ÁóõÊÅ®„ÅÆ‰∏ÄÊíÉÔºÅÔºÅ</span>";
          speak(isBonus ? "Áóõ„ÅÑ„Åß„Åô„Å≠„Éª„Éª„Éª„Åì„Çå„ÅØÁóõ„ÅÑ„Éª„Éª„Éª" : "„ÅÇ„Éº„ÇÇ„ÅÜ„ÇÅ„Å°„ÇÉ„Åè„Å°„ÇÉ„Å†„Çà");
          if (player.hp >= 60) playerDmg = 50;
          else playerDmg = Math.max(10, player.hp - 10);
        } else {
          document.getElementById("log").textContent = "„Å§„ÅÜÊÅ®„ÅÆ „Éü„ÇπÔºÅ";
          speak(isBonus ? "Áóõ„ÅÑ„Åß„Åô„Å≠„Éª„Éª„Éª„Åì„Çå„ÅØÁóõ„ÅÑ„Éª„Éª„Éª" : "„ÅÇ„Éº„ÇÇ„ÅÜ„ÇÅ„Å°„ÇÉ„Åè„Å°„ÇÉ„Å†„Çà");
        }
        damagePlayer(playerDmg);
        
        let insertIdx = Math.floor(Math.random() * (pool.length / 2));
        pool.splice(insertIdx, 0, currentQ);
      }
      
      updateUI();

      // „Äê‰øÆÊ≠£„Äë„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„ÅüÁõ¥Âæå„Å´HP„Åå‰Ωé„Åë„Çå„Å∞„ÄÅÊ¨°„ÅÆÂïèÈ°å„É≠„Éº„ÉâÂâç„Å´ÂõûÂæ©„Ç§„Éô„É≥„Éà„ÇíÂâ≤„ÇäËæº„Åæ„Åõ„Çã
      setTimeout(() => {
        if (monster.hp <= 0) {
          handleDefeat();
        } else if (player.hp > 0 && player.hp <= 20 && player.canHeal) {
          showHealEvent(); // ÁÄïÊ≠ª„Å™„ÇâÂç≥ÂõûÂæ©ÁîªÈù¢„Å∏
        } else if (player.hp > 0) {
          loadQuestion();
        }
      }, delay);
    }

    function triggerThunderEffect() {
      const effectLayer = document.getElementById("effect-layer");
      const thunder = document.createElement("div");
      thunder.className = "thunder";
      effectLayer.appendChild(thunder);
      document.body.classList.add("shake");
      setTimeout(() => { thunder.remove(); document.body.classList.remove("shake"); }, 500);
    }

    function triggerCriticalEffect() {
      document.getElementById("log").textContent = "‰ºöÂøÉ„ÅÆ‰∏ÄÊíÉÔºÅ50„ÉÄ„É°„Éº„Ç∏ÔºÅ";
      const effectArea = document.getElementById("monster-effects");
      const slash = document.createElement("div"); slash.className = "slash";
      effectArea.appendChild(slash);
      const critText = document.createElement("div"); critText.className = "critical-text";
      critText.textContent = "Critical Damage!"; effectArea.appendChild(critText);
      const effectLayer = document.getElementById("effect-layer");
      const flash = document.createElement("div"); flash.className = "flash-blue";
      effectLayer.appendChild(flash);
      document.getElementById("game-screen").classList.add("critical-shake");
      setTimeout(() => {
        slash.remove(); critText.remove(); flash.remove();
        document.getElementById("game-screen").classList.remove("critical-shake");
      }, 500);
    }

    function startBattle() {
      clearInterval(bonusImgInterval); clearInterval(timerInt);
      isBonus = false; bossMistakes = 0; player.canHeal = true;
      isBoss = (player.wins > 0 && (player.wins + 1) % 5 === 0);
      monster.maxHp = isBoss ? 200 : 70; monster.hp = monster.maxHp;
      
      const mEmoji = document.getElementById("monster-emoji");
      const mName = document.getElementById("monster-name");
      mEmoji.style.display = "block";
      if (isBoss) {
        mEmoji.textContent = "üêâ"; mName.textContent = "È≠îÁéã (BOSS)";
        mName.style.color = "red"; mName.style.borderColor = "red";
      } else {
        const data = monsterData[Math.floor(Math.random()*monsterData.length)];
        mEmoji.textContent = data.emoji; mName.textContent = data.name;
        mName.style.color = "#fff"; mName.style.borderColor = "#fff";
      }
      document.getElementById("bonus-image-view").style.display = "none";
      document.getElementById("victory-image-view").style.display = "none";
      document.getElementById("boss-timer").style.display = isBoss ? "block" : "none";
      document.getElementById("bonus-banner").style.display = "none";
      document.getElementById("next-area").style.display = "none";
      document.getElementById("btn-menu").style.display = "none";
      document.getElementById("next").style.display = "inline-block";
      updateUI();
      loadQuestion();
    }

    function loadQuestion() {
      if (pool.length === 0) {
        if (usedPool.length > 0) {
          pool = [...usedPool].sort(() => Math.random() - 0.5);
          usedPool = [];
        } else {
          return;
        }
      }
      
      // loadQuestionÂÜÖ„Åß„ÇÇ‰∏ÄÂøú„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„Åå„ÄÅ„É°„Ç§„É≥„ÅØcheckAnswer„Åã„Çâ„ÅÆÂâ≤„ÇäËæº„Åø
      if (player.hp <= 20 && player.canHeal) { showHealEvent(); return; }
      
      currentQ = pool.pop();
      document.getElementById("question").textContent = currentQ.q;
      speakEnglish(currentQ.q);
      
      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";
      [...currentQ.choices].sort(() => Math.random() - 0.5).forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => checkAnswer(c);
        choicesEl.appendChild(btn);
      });
      if (isBoss && !isBonus) startTimer();
    }

    function startTimer() {
      timeLeft = 10; clearInterval(timerInt);
      timerInt = setInterval(() => {
        timeLeft -= 0.1; document.getElementById("time-num").textContent = Math.ceil(timeLeft);
        document.getElementById("timer-fill").style.width = (timeLeft * 10) + "%";
        if (timeLeft <= 0) { clearInterval(timerInt); checkAnswer(""); }
      }, 100);
    }

    function damagePlayer(dmg) {
      player.hp -= dmg;
      if (player.hp <= 0) { player.hp = 0; }
    }

    function updateUI() {
      document.getElementById("hp").textContent = player.hp;
      document.getElementById("hp-display").style.color = player.hp <= 20 ? "#ff4757" : "#fff";
      document.getElementById("wins").textContent = player.wins;
      document.getElementById("level").textContent = Math.floor(player.wins / 3) + 1;
      const pct = Math.max(0, (monster.hp / monster.maxHp) * 100);
      document.getElementById("monster-hp-bar").style.width = pct + "%";
    }

    function highlightCorrect() {
      const btns = document.querySelectorAll("#choices button");
      btns.forEach(b => { 
        b.disabled = true; 
        if (b.textContent === currentQ.a) b.style.background = "#2ecc71"; 
        else b.style.opacity = "0.5"; 
      });
    }

    function handleDefeat() {
      if (isBoss && bossMistakes === 0) startBonus();
      else {
        if (isBonus) { 
          bonusBgm.pause(); bonusBgm.currentTime = 0; clearInterval(bonusImgInterval);
          speak("„Ç§„ÇØ„Ç§„ÇØ „Ç§„Ç§„É®„Ç≥„Ç§„É®„ÄÇ„Ç§„Ç≠„Çπ„ÇÆ„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£„Ç£"); 
          document.getElementById("bonus-image-view").style.display = "none";
          const vic = document.getElementById("victory-image-view"); vic.style.display = "block"; vic.src = "1000046945.png";
          document.getElementById("btn-menu").style.display = "inline-block";
          document.getElementById("next").style.display = "none";
        } else if (isBoss) document.getElementById("btn-menu").style.display = "inline-block";
        player.wins++; 
        document.getElementById("log").textContent = "Êïµ„Çí „Åü„Åä„Åó„ÅüÔºÅ";
        document.getElementById("next-area").style.display = "block";
        document.getElementById("choices").innerHTML = "";
      }
    }

    function startBonus() {
      isBonus = true; isBoss = false; monster.maxHp = 350; monster.hp = 350;
      bonusBgm.play().catch(e => {});
      document.getElementById("bonus-banner").style.display = "block";
      document.getElementById("monster-emoji").style.display = "none";
      document.getElementById("monster-name").textContent = "??? (BONUS)";
      document.getElementById("boss-timer").style.display = "none";
      const bView = document.getElementById("bonus-image-view"); bView.style.display = "block";
      bonusImgInterval = setInterval(() => {
        const rndPos = ["0% 0%", "50% 0%", "100% 0%", "0% 50%", "50% 50%", "100% 50%", "0% 100%", "50% 100%", "100% 100%"][Math.floor(Math.random() * 9)];
        bView.style.backgroundPosition = rndPos; bView.style.filter = `hue-rotate(${Math.random()*360}deg)`;
      }, 2000);
      updateUI(); loadQuestion();
    }

    function selectDifficulty(f) {
      document.getElementById("diff-buttons").style.display = "none";
      document.getElementById("loading-msg").style.display = "block";
      const s = document.createElement('script');
      s.src = f;
      s.onload = () => { 
        setTimeout(() => {
          if (typeof masterQuestions !== 'undefined') {
            document.getElementById("difficulty-modal").style.display = "none";
            init(); 
          } else { alert("„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ"); }
        }, 600);
      };
      document.body.appendChild(s);
    }

    function init() {
      pool = [...masterQuestions].sort(() => Math.random() - 0.5);
      startBattle();
    }

    function returnToMenu() { bonusBgm.pause(); bonusBgm.currentTime = 0; location.reload(); }
    function openReviewAnytime() { speak("„ÅÇ„Å£„ÄÅ„ÅÑ„ÅÑ„Å£„Åô„Çà"); showReview(); }
    function showReview() {
      const modal = document.getElementById("review-modal");
      const list = document.getElementById("review-list");
      list.innerHTML = missList.length === 0 ? "„Éü„Çπ„Å™„Åó„ÄÇ" : "";
      missList.forEach((m, i) => {
        list.innerHTML += `<div class="review-item">${i+1}. ${m.q}<br><span style="color:#2ecc71;">Ê≠£Ëß£: ${m.a}</span><br><button class="btn-focus" onclick="setFocusQuestion(${i})">ÂÑ™ÂÖàÂá∫È°å</button></div>`;
      });
      modal.style.display = "flex";
      if (player.hp <= 0) {
          speak("„Éå„ÉÉÔºÅ");
          document.getElementById("log").textContent = "„ÅÇ„Å™„Åü„ÅØ „Åü„Åä„Çå„Åü‚Ä¶";
      }
    }
    function setFocusQuestion(index) {
      const item = missList[index];
      pool = pool.filter(q => q.q !== item.q); pool.push({q:item.q, a:item.a, choices:item.choices});
      closeReview();
    }
    function closeReview() { if (player.hp <= 0) location.reload(); else document.getElementById("review-modal").style.display = "none"; }
    
    // ÂõûÂæ©„Ç§„Éô„É≥„ÉàÁîªÈù¢
    function showHealEvent() {
      document.getElementById("log").textContent = "ÁÄïÊ≠ª„ÅÆÁä∂ÊÖã„Å†ÔºÅ";
      document.getElementById("question").innerHTML = "<span style='color:#ff4757; font-size:1.2rem; font-weight:bold;'>Á•û„Å´ „ÅÑ„ÅÆ„Çä„Åæ„Åô„ÅãÔºü</span>";
      const choicesEl = document.getElementById("choices"); choicesEl.innerHTML = "";
      const healBtn = document.createElement("button"); 
      healBtn.textContent = "„ÅÑ„ÅÆ„ÇãÔºàHPÂõûÂæ©„Éª‰∏ÄÂ∫¶„Å†„ÅëÔºâ";
      healBtn.style.borderColor = "gold";
      healBtn.onclick = () => { 
        player.hp = Math.min(player.maxHp, player.hp + 60); 
        player.canHeal = false; 
        updateUI(); 
        document.getElementById("log").textContent = "HP„Åå 60 „Åã„ÅÑ„Åµ„Åè„Åó„ÅüÔºÅ";
        setTimeout(loadQuestion, 1000); 
      };
      choicesEl.appendChild(healBtn);
      
      const noBtn = document.createElement("button");
      noBtn.textContent = "„ÅÑ„ÅÆ„Çâ„Å™„ÅÑ";
      noBtn.onclick = () => { loadQuestion(); };
      choicesEl.appendChild(noBtn);
    }
    window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
  </script>
</body>
</html>
