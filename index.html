<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ENGLISH QUEST - FULL EDITION</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    body { display: flex; flex-direction: column; box-sizing: border-box; padding: 10px; }
    #game-container { display: flex; flex: 1; flex-direction: column; }
    #game-screen { flex: 1; display: flex; flex-direction: column; background: linear-gradient(to bottom, #1e3c72, #2a5298); border: 4px solid #fff; border-radius: 8px; position: relative; overflow: hidden; }
    #monster-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #monster-image { width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; position: relative; }
    /* ÈÄèÊòéÁîªÂÉèÂØæÁ≠ñ: ËÉåÊôØÁôΩ + Êû† */
    #monster-img-tag { width: 100%; height: 100%; object-fit: contain; background: #fff; border: 4px solid #ffd700; border-radius: 12px; display: none; box-shadow: 0 0 20px rgba(255,255,255,0.3); }
    #monster-emoji { font-size: 80px; }
    #boss-timer { display: none; position: absolute; top: 10px; right: 10px; background: #000; color: #ff4757; border: 2px solid #ff4757; padding: 5px; font-family: monospace; width: 70px; text-align: center; }
    #timer-fill { height: 4px; background: #ff4757; width: 100%; margin-top: 2px; }
    #ui-area { flex: 1.5; display: flex; flex-direction: column; background: #000; border: 4px solid #fff; border-radius: 8px; margin-top: 8px; padding: 10px; }
    #status { display: flex; justify-content: space-around; font-size: 0.9rem; border-bottom: 2px solid #fff; padding-bottom: 5px; }
    #question { font-size: 0.9rem; text-align: center; min-height: 4.5em; display: flex; align-items: center; justify-content: center; padding: 5px; }
    #choices { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    #choices button { padding: 15px 5px; font-size: 0.85rem; background: #000; color: #fff; border: 2px solid #fff; border-radius: 5px; cursor: pointer; }
    #log { font-size: 0.9rem; color: #ffff00; text-align: center; margin: 10px 0; font-weight: bold; min-height: 1.2em; }
    #next { width: 100%; padding: 15px; background: #fff; color: #000; font-weight: bold; border: none; display: none; border-radius: 5px; cursor: pointer; }
    #bonus-banner { display: none; position: absolute; top: 15%; left: 50%; transform: translateX(-50%); color: gold; font-size: 1.8rem; font-weight: bold; text-shadow: 2px 2px #000; z-index: 10; animation: flash 0.5s infinite alternate; }
    @keyframes flash { from { opacity: 1; } to { opacity: 0.3; } }
    .shake { animation: shake 0.2s ease-in-out 2; }
    @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-8px,0); } 75% { transform: translate(8px,0); } }
  </style>
</head>
<body>

  <div id="game-container">
    <div id="game-screen">
      <div id="bonus-banner">BONUS STAGE</div>
      <div id="boss-timer">TIME:<span id="time-num">10</span><div id="timer-fill"></div></div>
      <div id="monster-area">
        <div id="monster-image">
          <span id="monster-emoji">üëæ</span>
          <img id="monster-img-tag" src="" alt="Bonus">
        </div>
        <div style="width:120px; height:10px; background:#333; border:2px solid #fff; margin-top:10px;">
          <div id="monster-hp" style="height:100%; background:#f00; width:100%; transition: width 0.3s;"></div>
        </div>
      </div>
    </div>

    <div id="ui-area">
      <div id="status">
        <div>HP: <span id="hp">100</span></div>
        <div>LV: <span id="level">1</span></div>
        <div>WIN: <span id="wins">0</span></div>
      </div>
      <div id="question"></div>
      <div id="choices"></div>
      <div id="log"></div>
      <button id="next">‚ñ∂ NEXT STAGE</button>
    </div>
  </div>

  <script src="questions.js"></script>

  <script>
    let player = { hp: 100, level: 1, wins: 0 };
    let currentMonster = { hp: 70, maxHp: 70 };
    let pool = [], usedPool = [];
    let isBoss = false, isBonus = false, bossMistakes = 0;
    let timerInt, timeLeft = 10;
    let bonusImgInterval;

    // Áî∑ÊÄß„ÅÆÈáéÂ§™„ÅÑÂ£∞„ÅÆË®≠ÂÆö
    function speak(text) {
      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = "ja-JP";
      uttr.pitch = 0.4; // ‰ΩéÈü≥
      uttr.rate = 0.8;  // „ÇÜ„Å£„Åè„Çä
      window.speechSynthesis.speak(uttr);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function init() {
      // masterQuestions„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
      if (typeof masterQuestions === 'undefined') {
          alert("questions.js „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÂêå„Åò„Éï„Ç©„É´„ÉÄ„Å´ÁΩÆ„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          return;
      }
      pool = shuffle([...masterQuestions]);
      nextBattle();
    }

    function nextBattle() {
      clearInterval(bonusImgInterval);
      isBonus = false; bossMistakes = 0;
      player.wins++;
      isBoss = player.wins % 5 === 0;

      currentMonster = { hp: isBoss ? 200 : 70, maxHp: isBoss ? 200 : 70 };
      
      document.getElementById("monster-emoji").style.display = "block";
      document.getElementById("monster-img-tag").style.display = "none";
      document.getElementById("boss-timer").style.display = isBoss ? "block" : "none";
      document.getElementById("bonus-banner").style.display = "none";
      document.getElementById("next").style.display = "none";
      document.getElementById("log").textContent = isBoss ? "„Éú„ÇπÊà¶ÔºÅ„Éé„Éº„Éü„Çπ„Åß„Éú„Éº„Éä„Çπ„Å∏ÔºÅ" : "Êïµ„ÅåÁèæ„Çå„ÅüÔºÅ";
      
      loadQuestion();
      updateUI();
    }

    function startBonusStage() {
      isBonus = true; isBoss = false;
      document.getElementById("bonus-banner").style.display = "block";
      document.getElementById("monster-emoji").style.display = "none";
      document.getElementById("monster-img-tag").style.display = "block";
      document.getElementById("monster-img-tag").src = "1000046944.jpg"; 
      currentMonster = { hp: 150, maxHp: 150 };

      // „Éú„Éº„Éä„ÇπÁîªÂÉè„É©„É≥„ÉÄ„É†ÊºîÂá∫
      bonusImgInterval = setInterval(() => {
        const img = document.getElementById("monster-img-tag");
        img.style.filter = `hue-rotate(${Math.random()*360}deg) brightness(1.1)`;
        img.style.transform = `scale(${0.9 + Math.random()*0.2})`;
      }, 2000);

      loadQuestion();
    }

    function loadQuestion() {
      if (pool.length === 0) { pool = shuffle([...usedPool]); usedPool = []; }
      const q = pool.pop();
      currentQuestion = q;
      document.getElementById("question").textContent = q.q;
      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";
      shuffle([...q.choices]).forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = c;
        btn.onclick = () => checkAnswer(c, q.a, btn);
        choicesEl.appendChild(btn);
      });
      if (isBoss) startTimer();
    }

    function startTimer() {
      timeLeft = 10;
      clearInterval(timerInt);
      timerInt = setInterval(() => {
        timeLeft -= 0.1;
        document.getElementById("time-num").textContent = Math.ceil(timeLeft);
        document.getElementById("timer-fill").style.width = (timeLeft * 10) + "%";
        if (timeLeft <= 0) {
          clearInterval(timerInt);
          bossMistakes++;
          handleDamage(10);
          loadQuestion();
        }
      }, 100);
    }

    function checkAnswer(choice, answer, btn) {
      clearInterval(timerInt);
      const buttons = document.querySelectorAll("#choices button");
      buttons.forEach(b => b.disabled = true);

      if (choice === answer) {
        btn.style.background = "#2ecc71";
        currentMonster.hp -= 50;
        document.getElementById("log").textContent = "Ê≠£Ëß£ÔºÅ";
        if (isBonus) speak("„ÇÑ„Çä„Åæ„Åô„Å≠„Åá");
        usedPool.push(currentQuestion);
      } else {
        btn.style.background = "#e74c3c";
        if (isBoss) bossMistakes++;
        handleDamage(15);
        document.getElementById("log").textContent = "‰∏çÊ≠£Ëß£ÔºÅ";
        pool.unshift(currentQuestion);
      }

      setTimeout(() => {
        if (currentMonster.hp <= 0) {
          if (isBoss && bossMistakes === 0) {
            startBonusStage();
          } else {
            if (isBonus) {
              clearInterval(bonusImgInterval);
              speak("„Åò„ÇÉ„Åë„Çì„ÄÅÂ§úË°å„Åç„Åæ„Åó„Çá„ÅÜ„Å≠");
              document.getElementById("monster-img-tag").src = "1000046945.png";
              document.getElementById("monster-img-tag").style.filter = "none";
            }
            document.getElementById("log").textContent = "WIN!";
            document.getElementById("next").style.display = "block";
          }
        } else {
          loadQuestion();
        }
        updateUI();
      }, 800);
    }

    function handleDamage(dmg) {
      player.hp -= dmg;
      document.body.classList.add("shake");
      setTimeout(() => document.body.classList.remove("shake"), 200);
      if (player.hp <= 0) {
        alert("GAME OVER");
        location.reload();
      }
    }

    function updateUI() {
      document.getElementById("hp").textContent = player.hp;
      document.getElementById("wins").textContent = player.wins;
      document.getElementById("level").textContent = Math.floor(player.wins / 3) + 1;
      const percent = (currentMonster.hp / currentMonster.maxHp) * 100;
      document.getElementById("monster-hp").style.width = Math.max(0, percent) + "%";
    }

    document.getElementById("next").onclick = nextBattle;
    window.onload = init;
  </script>
</body>
</html>
